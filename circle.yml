machine:
  services:
    - docker

dependencies:
  override:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" -e "$DOCKER_EMAIL"
    - docker pull "codeclimate/codeclimate-pmd:${CIRCLE_BRANCH//\//-}" || docker pull codeclimate/codeclimate-pmd || true
    - git rev-parse HEAD > REVISION
    - git rev-list --count HEAD > COMMIT_COUNT
    - make image

test:
  override:
    - make test

deployment:
  release:
    branch: master
    owner: codeclimate
    commands:
      - docker push codeclimate/codeclimate-pmd
  staging:
    branch: /master|channel\/[\w-]+/
    owner: codeclimate
    commands:
      - docker tag codeclimate/codeclimate-pmd codeclimate/codeclimate-pmd:${CIRCLE_BUILD_NUM}
      - docker push codeclimate/codeclimate-pmd:${CIRCLE_BUILD_NUM}
      - docker tag codeclimate/codeclimate-pmd codeclimate/codeclimate-pmd:${CIRCLE_BRANCH//\//-}
      - docker push codeclimate/codeclimate-pmd:${CIRCLE_BRANCH//\//-}

notify:
  webhooks:
    - url: https://cc-slack-proxy.herokuapp.com/circle
